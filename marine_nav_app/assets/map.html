<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SailStream Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #0a1f3f;
      }
      #loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 8px;
        color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        z-index: 10;
        background: #0a1f3f;
        transition: opacity 0.3s ease;
      }
      #loading.hidden { opacity: 0; pointer-events: none; }
      .badge {
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(0, 201, 167, 0.2);
        color: #00c9a7;
        border: 1px solid rgba(0, 201, 167, 0.5);
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="loading">
      <div class="badge">Loading MapTiler…</div>
    </div>

    <script>
      // Bridge for Dart ↔ JS communication
      window.mapBridge = {
        _map: null,
        _suppressEvents: false,
        _apiKey: null,

        // Called from Dart to set the MapTiler API key and initialize
        setApiKey: function (key) {
          this._apiKey = key;
          this._initMap();
        },

        // Initialize MapLibre GL map
        _initMap: function () {
          if (!this._apiKey || this._map) return;

          try {
            this._map = new maplibregl.Map({
              container: 'map',
              style:
                'https://api.maptiler.com/maps/ocean/style.json?key=' +
                this._apiKey,
              center: [0, 0],
              zoom: 3,
              attributionControl: false,
            });

            this._map.addControl(
              new maplibregl.AttributionControl({ compact: true }),
              'bottom-right'
            );

            this._map.on('load', function () {
              document.getElementById('loading').classList.add('hidden');
              window.mapBridge._sendToDart({
                type: 'mapReady',
              });
            });

            this._map.on('moveend', function () {
              window.mapBridge._emitViewport();
            });

            this._map.on('zoomend', function () {
              window.mapBridge._emitViewport();
            });

            this._map.on('rotateend', function () {
              window.mapBridge._emitViewport();
            });

            this._map.on('error', function (e) {
              window.mapBridge._sendToDart({
                type: 'error',
                message: e.error ? e.error.message : 'Map error',
              });
            });
          } catch (e) {
            this._sendToDart({
              type: 'error',
              message: 'Map init failed: ' + e.message,
            });
          }
        },

        // Emit current viewport state to Dart
        _emitViewport: function () {
          if (this._suppressEvents || !this._map) return;
          var center = this._map.getCenter();
          this._sendToDart({
            type: 'viewportChanged',
            center: [center.lat, center.lng],
            zoom: this._map.getZoom(),
            rotation: (-this._map.getBearing() * Math.PI) / 180,
          });
        },

        // Send JSON message to Dart via MapBridge channel
        _sendToDart: function (obj) {
          try {
            if (window.MapBridge) {
              window.MapBridge.postMessage(JSON.stringify(obj));
            }
          } catch (e) {
            console.error('MapBridge send failed:', e);
          }
        },

        // Called from Dart to update map center
        setCenter: function (lat, lng) {
          if (!this._map) return;
          this._suppressEvents = true;
          this._map.setCenter([lng, lat]);
          this._suppressEvents = false;
        },

        // Called from Dart to update zoom level
        setZoom: function (zoom) {
          if (!this._map) return;
          this._suppressEvents = true;
          this._map.setZoom(zoom);
          this._suppressEvents = false;
        },

        // Called from Dart to update rotation (radians → degrees)
        setRotation: function (radians) {
          if (!this._map) return;
          this._suppressEvents = true;
          this._map.setBearing((-radians * 180) / Math.PI);
          this._suppressEvents = false;
        },

        // Called from Dart to fly to a location with animation
        flyTo: function (lat, lng, zoom) {
          if (!this._map) return;
          this._map.flyTo({
            center: [lng, lat],
            zoom: zoom || this._map.getZoom(),
            essential: true,
          });
        },

        // Called from Dart to update viewport in one call
        setViewport: function (lat, lng, zoom, radians) {
          if (!this._map) return;
          this._suppressEvents = true;
          this._map.jumpTo({
            center: [lng, lat],
            zoom: zoom,
            bearing: (-radians * 180) / Math.PI,
          });
          this._suppressEvents = false;
        },

        // ============ Boat Marker ============
        _boatMarker: null,
        _boatEl: null,

        updateBoatMarker: function (lat, lng, headingDeg) {
          if (!this._map) return;

          if (!this._boatEl) {
            this._boatEl = document.createElement('div');
            this._boatEl.innerHTML =
              '<svg width="32" height="32" viewBox="0 0 32 32">' +
              '<polygon points="16,2 26,28 16,22 6,28" ' +
              'fill="#00D9FF" fill-opacity="0.85" ' +
              'stroke="#00FFFF" stroke-width="1.5"/>' +
              '</svg>';
            this._boatEl.style.cssText =
              'width:32px;height:32px;transition:transform 0.3s ease;' +
              'filter:drop-shadow(0 0 6px #00D9FF) drop-shadow(0 0 12px #00D9FF80);';
          }

          this._boatEl.style.transform = 'rotate(' + headingDeg + 'deg)';

          if (!this._boatMarker) {
            this._boatMarker = new maplibregl.Marker({
              element: this._boatEl,
              anchor: 'center',
              rotationAlignment: 'map',
            })
              .setLngLat([lng, lat])
              .addTo(this._map);
          } else {
            this._boatMarker.setLngLat([lng, lat]);
          }
        },

        // ============ Track Line ============

        updateTrackLine: function (coords) {
          if (!this._map) return;
          var src = this._map.getSource('track-line');
          var geojson = {
            type: 'Feature',
            geometry: { type: 'LineString', coordinates: coords },
          };
          if (src) {
            src.setData(geojson);
          } else {
            this._map.addSource('track-line', {
              type: 'geojson',
              data: geojson,
            });
            this._map.addLayer({
              id: 'track-line-layer',
              type: 'line',
              source: 'track-line',
              paint: {
                'line-color': '#00D9FF',
                'line-width': 2,
                'line-opacity': 0.6,
              },
            });
          }
        },

        clearTrackLine: function () {
          if (!this._map) return;
          var src = this._map.getSource('track-line');
          if (src) {
            src.setData({
              type: 'Feature',
              geometry: { type: 'LineString', coordinates: [] },
            });
          }
        },

        // ============ Route Line & Waypoints ============
        _waypointMarkers: [],

        updateRouteLine: function (coords) {
          if (!this._map) return;
          var src = this._map.getSource('route-line');
          var geojson = {
            type: 'Feature',
            geometry: { type: 'LineString', coordinates: coords },
          };
          if (src) {
            src.setData(geojson);
          } else {
            this._map.addSource('route-line', { type: 'geojson', data: geojson });
            this._map.addLayer({
              id: 'route-line-layer',
              type: 'line',
              source: 'route-line',
              paint: {
                'line-color': '#FF00FF',
                'line-width': 3,
                'line-opacity': 0.8,
                'line-dasharray': [4, 3],
              },
            });
          }
        },

        updateWaypointMarkers: function (waypoints) {
          if (!this._map) return;
          // Remove existing markers
          this._waypointMarkers.forEach(function (m) { m.remove(); });
          this._waypointMarkers = [];
          // Create new markers
          waypoints.forEach(function (wp, i) {
            var el = document.createElement('div');
            var isLast = i === waypoints.length - 1;
            var color = isLast ? '#00FF88' : '#FF00FF';
            el.innerHTML =
              '<svg width="24" height="24" viewBox="0 0 24 24">' +
              '<circle cx="12" cy="12" r="10" fill="' + color + '" fill-opacity="0.25" ' +
              'stroke="' + color + '" stroke-width="2"/>' +
              '<text x="12" y="16" text-anchor="middle" fill="' + color + '" ' +
              'font-size="11" font-weight="bold" font-family="sans-serif">' +
              (i + 1) + '</text></svg>';
            el.style.cssText = 'width:24px;height:24px;cursor:pointer;' +
              'filter:drop-shadow(0 0 4px ' + color + '80);';
            el.title = wp.name || 'WP ' + (i + 1);
            var marker = new maplibregl.Marker({ element: el, anchor: 'center' })
              .setLngLat([wp.lng, wp.lat])
              .addTo(window.mapBridge._map);
            window.mapBridge._waypointMarkers.push(marker);
          });
        },

        clearRoute: function () {
          if (!this._map) return;
          var src = this._map.getSource('route-line');
          if (src) {
            src.setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: [] } });
          }
          this._waypointMarkers.forEach(function (m) { m.remove(); });
          this._waypointMarkers = [];
        },
      };
    </script>
  </body>
</html>
